<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Facial Recognition App (CDN Models)</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Facial Recognition & LinkedIn Finder</h1>
            <p>Allow camera access to identify faces and find LinkedIn profiles</p>
        </header>
        
        <main>
            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="overlay-container"></div>
            </div>
            
            <div class="controls">
                <button id="start-btn" class="btn primary">Start Camera</button>
                <button id="stop-btn" class="btn secondary" disabled>Stop Camera</button>
            </div>
            
            <div id="status" class="status-message">Ready to start</div>
            <div id="error" class="error-message hidden"></div>
            
            <div id="debug" style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
        </main>
    </div>

    <!-- Load face-api.js -->
    <script src="node_modules/face-api.js/dist/face-api.min.js"></script>
    
    <script>
        const debugDiv = document.getElementById('debug');
        function debug(message) {
            console.log(message);
            debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        class SimpleFacialRecognitionApp {
            constructor() {
                this.videoElement = document.getElementById('video');
                this.canvasElement = document.getElementById('canvas');
                this.startButton = document.getElementById('start-btn');
                this.stopButton = document.getElementById('stop-btn');
                this.statusElement = document.getElementById('status');
                this.errorElement = document.getElementById('error');
                
                this.currentStream = null;
                this.isRunning = false;
                this.modelsLoaded = false;
                
                debug('App initialized');
                this.setupEventListeners();
                this.loadModels();
            }
            
            setupEventListeners() {
                this.startButton.addEventListener('click', () => this.startCamera());
                this.stopButton.addEventListener('click', () => this.stopCamera());
                debug('Event listeners setup');
            }
            
            async loadModels() {
                try {
                    this.updateStatus('Loading face detection models from CDN...');
                    debug('Starting model loading...');
                    
                    // Load models from CDN (more reliable)
                    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
                    
                    debug('Loading SSD MobileNet...');
                    await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                    debug('SSD MobileNet loaded');
                    
                    debug('Loading Face Landmarks...');
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                    debug('Face Landmarks loaded');
                    
                    debug('Loading Face Recognition...');
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                    debug('Face Recognition loaded');
                    
                    this.modelsLoaded = true;
                    this.updateStatus('Models loaded! Ready to start camera.');
                    debug('All models loaded successfully!');
                    
                } catch (error) {
                    this.showError('Failed to load face detection models: ' + error.message);
                    debug('Model loading error: ' + error.message);
                    console.error('Model loading error:', error);
                }
            }
            
            async startCamera() {
                try {
                    if (!this.modelsLoaded) {
                        this.showError('Please wait for models to load first');
                        debug('Camera start blocked - models not loaded');
                        return;
                    }
                    
                    debug('Starting camera...');
                    this.updateStatus('Starting camera...');
                    this.startButton.disabled = true;
                    
                    // Get camera stream
                    this.currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 }
                    });
                    debug('Camera stream obtained');
                    
                    this.videoElement.srcObject = this.currentStream;
                    
                    // Wait for video to load
                    await new Promise((resolve) => {
                        this.videoElement.onloadedmetadata = resolve;
                    });
                    debug('Video metadata loaded');
                    
                    // Setup canvas
                    this.canvasElement.width = this.videoElement.videoWidth;
                    this.canvasElement.height = this.videoElement.videoHeight;
                    debug(`Canvas setup: ${this.canvasElement.width}x${this.canvasElement.height}`);
                    
                    this.isRunning = true;
                    this.startButton.disabled = true;
                    this.stopButton.disabled = false;
                    this.updateStatus('Camera active - detecting faces...');
                    
                    // Start face detection
                    this.detectFaces();
                    debug('Face detection started');
                    
                } catch (error) {
                    this.showError('Camera error: ' + error.message);
                    this.startButton.disabled = false;
                    debug('Camera error: ' + error.message);
                    console.error('Camera error:', error);
                }
            }
            
            stopCamera() {
                debug('Stopping camera...');
                this.isRunning = false;
                
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                    this.videoElement.srcObject = null;
                }
                
                this.startButton.disabled = false;
                this.stopButton.disabled = true;
                this.updateStatus('Camera stopped');
                debug('Camera stopped');
            }
            
            async detectFaces() {
                if (!this.isRunning) return;
                
                try {
                    // Detect faces
                    const detections = await faceapi
                        .detectAllFaces(this.videoElement)
                        .withFaceLandmarks();
                    
                    // Clear canvas
                    const ctx = this.canvasElement.getContext('2d');
                    ctx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                    
                    // Draw face boxes
                    detections.forEach((detection, i) => {
                        const box = detection.detection.box;
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        // Draw confidence
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '16px Arial';
                        ctx.fillText(
                            `${Math.round(detection.detection.score * 100)}%`, 
                            box.x, 
                            box.y - 5
                        );
                    });
                    
                    if (detections.length > 0) {
                        debug(`Detected ${detections.length} face(s)`);
                    }
                    
                } catch (error) {
                    debug('Detection error: ' + error.message);
                    console.error('Detection error:', error);
                }
                
                // Continue detection loop
                if (this.isRunning) {
                    requestAnimationFrame(() => this.detectFaces());
                }
            }
            
            updateStatus(message) {
                this.statusElement.textContent = message;
                this.errorElement.classList.add('hidden');
            }
            
            showError(message) {
                this.errorElement.textContent = message;
                this.errorElement.classList.remove('hidden');
                this.statusElement.textContent = '';
            }
        }
        
        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            debug('DOM loaded, starting app...');
            new SimpleFacialRecognitionApp();
        });
    </script>
</body>
</html>