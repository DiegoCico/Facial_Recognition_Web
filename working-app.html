<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Facial Recognition App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Facial Recognition & LinkedIn Finder</h1>
            <p>Allow camera access to identify faces and find LinkedIn profiles</p>
        </header>
        
        <main>
            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="overlay-container"></div>
            </div>
            
            <div class="controls">
                <button id="start-btn" class="btn primary">Start Camera</button>
                <button id="stop-btn" class="btn secondary" disabled>Stop Camera</button>
            </div>
            
            <div id="status" class="status-message">Ready to start</div>
            <div id="error" class="error-message hidden"></div>
        </main>
    </div>

    <!-- Load face-api.js -->
    <script src="node_modules/face-api.js/dist/face-api.min.js"></script>
    
    <script>
        class SimpleFacialRecognitionApp {
            constructor() {
                this.videoElement = document.getElementById('video');
                this.canvasElement = document.getElementById('canvas');
                this.startButton = document.getElementById('start-btn');
                this.stopButton = document.getElementById('stop-btn');
                this.statusElement = document.getElementById('status');
                this.errorElement = document.getElementById('error');
                
                this.currentStream = null;
                this.isRunning = false;
                this.modelsLoaded = false;
                
                this.setupEventListeners();
                this.loadModels();
            }
            
            setupEventListeners() {
                this.startButton.addEventListener('click', () => this.startCamera());
                this.stopButton.addEventListener('click', () => this.stopCamera());
            }
            
            async loadModels() {
                try {
                    this.updateStatus('Loading face detection models...');
                    
                    // Load face-api.js models
                    await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
                    await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
                    await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
                    
                    this.modelsLoaded = true;
                    this.updateStatus('Models loaded! Ready to start camera.');
                    
                } catch (error) {
                    this.showError('Failed to load face detection models: ' + error.message);
                    console.error('Model loading error:', error);
                }
            }
            
            async startCamera() {
                try {
                    if (!this.modelsLoaded) {
                        this.showError('Please wait for models to load first');
                        return;
                    }
                    
                    this.updateStatus('Starting camera...');
                    this.startButton.disabled = true;
                    
                    // Get camera stream
                    this.currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 }
                    });
                    
                    this.videoElement.srcObject = this.currentStream;
                    
                    // Wait for video to load
                    await new Promise((resolve) => {
                        this.videoElement.onloadedmetadata = resolve;
                    });
                    
                    // Setup canvas
                    this.canvasElement.width = this.videoElement.videoWidth;
                    this.canvasElement.height = this.videoElement.videoHeight;
                    
                    this.isRunning = true;
                    this.startButton.disabled = true;
                    this.stopButton.disabled = false;
                    this.updateStatus('Camera active - detecting faces...');
                    
                    // Start face detection
                    this.detectFaces();
                    
                } catch (error) {
                    this.showError('Camera error: ' + error.message);
                    this.startButton.disabled = false;
                    console.error('Camera error:', error);
                }
            }
            
            stopCamera() {
                this.isRunning = false;
                
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                    this.videoElement.srcObject = null;
                }
                
                this.startButton.disabled = false;
                this.stopButton.disabled = true;
                this.updateStatus('Camera stopped');
            }
            
            async detectFaces() {
                if (!this.isRunning) return;
                
                try {
                    // Detect faces
                    const detections = await faceapi
                        .detectAllFaces(this.videoElement)
                        .withFaceLandmarks();
                    
                    // Clear canvas
                    const ctx = this.canvasElement.getContext('2d');
                    ctx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                    
                    // Draw face boxes
                    detections.forEach(detection => {
                        const box = detection.detection.box;
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        // Draw confidence
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '16px Arial';
                        ctx.fillText(
                            `${Math.round(detection.detection.score * 100)}%`, 
                            box.x, 
                            box.y - 5
                        );
                    });
                    
                } catch (error) {
                    console.error('Detection error:', error);
                }
                
                // Continue detection loop
                if (this.isRunning) {
                    requestAnimationFrame(() => this.detectFaces());
                }
            }
            
            updateStatus(message) {
                this.statusElement.textContent = message;
                this.errorElement.classList.add('hidden');
            }
            
            showError(message) {
                this.errorElement.textContent = message;
                this.errorElement.classList.remove('hidden');
                this.statusElement.textContent = '';
            }
        }
        
        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleFacialRecognitionApp();
        });
    </script>
</body>
</html>